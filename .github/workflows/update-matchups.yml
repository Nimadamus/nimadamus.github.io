name: Update MLB Matchups Daily

on:
  schedule:
    - cron: '0 15 * * *'  # every day at 8am PT
  workflow_dispatch:

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Create matchups.html
        run: |
          echo "require('dotenv').config();
          const axios = require('axios');
          const fs = require('fs');

          const API_KEY = process.env.API_SPORTS_KEY;
          const today = new Date().toISOString().split('T')[0];

          const headers = {
            'x-apisports-key': API_KEY,
          };

          const BASE_URL = 'https://v1.baseball.api-sports.io';

          async function fetchMLBGamesAndWriteHTML() {
            try {
              const gamesRes = await axios.get(\`\${BASE_URL}/games?league=1&season=2025&date=\${today}\`, { headers });
              const games = gamesRes.data.response;

              const gameCards = games.map(game => {
                const home = game.teams.home.name;
                const away = game.teams.away.name;
                const time = new Date(game.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const status = game.status.long;

                return \`
                  <div class='game-card'>
                    <h4>\${away} @ \${home}</h4>
                    <p>‚è∞ Start Time: \${time}</p>
                    <p>üìç Status: \${status}</p>
                  </div>
                \`;
              });

              const htmlOutput = \`
                <div id='mlb-matchups'>
                  \${gameCards.join('\\n')}
                </div>
              \`;

              fs.writeFileSync('matchups.html', htmlOutput);
              console.log('‚úÖ matchups.html created!');
            } catch (err) {
              console.error('‚ùå Error:', err.message);
              process.exit(1);
            }
          }

          fetchMLBGamesAndWriteHTML();" > updateMatchups.js

          npm install axios dotenv
          node updateMatchups.js

      - name: Commit and push matchups.html
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add matchups.html
          git commit -m "üîÑ Auto-update matchups.html"
          git push https://x-access-token:${GH_PAT}@github.com/Nimadamus/nimadamus.github.io.git HEAD:main
