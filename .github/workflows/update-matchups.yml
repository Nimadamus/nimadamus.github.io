name: Update MLB Matchups Daily

on:
  schedule:
    - cron: '0 15 * * *'  # runs daily at 8am PT / 3pm UTC
  workflow_dispatch:

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install axios dotenv

      - name: Create fetch script
        run: |
          echo "require('dotenv').config();
          const axios = require('axios');
          const fs = require('fs');
          const API_KEY = process.env.API_SPORTS_KEY;
          const today = new Date().toISOString().split('T')[0];
          const headers = { 'x-apisports-key': API_KEY };
          const BASE_URL = 'https://v1.baseball.api-sports.io';

          async function go() {
            try {
              const res = await axios.get(\`\${BASE_URL}/games?league=1&season=2025&date=\${today}\`, { headers });
              const games = res.data.response;
              const cards = games.map(g => {
                const home = g.teams.home.name;
                const away = g.teams.away.name;
                const time = new Date(g.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const status = g.status.long;
                return \`<div class='game-card'><h4>\${away} @ \${home}</h4><p>Start Time: \${time}</p><p>Status: \${status}</p></div>\`;
              });
              const html = \`<div id='mlb-matchups'>\${cards.join('\\n')}</div>\`;
              fs.writeFileSync('matchups.html', html);
            } catch (err) {
              console.error('Fetch failed:', err.message);
            }
          }

          go();" > fetch.js

      - name: Run fetch script
        run: node fetch.js

      - name: Commit updated matchups.html
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add matchups.html
          git commit -m "Auto-update matchups.html" || echo "No changes to commit"
          git push
