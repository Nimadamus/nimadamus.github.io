name: Content Quality Check

on:
  push:
    branches: [main, master]
    paths:
      - '*.html'
      - 'news/**'
      - 'blog/**'

jobs:
  validate-content:
    runs-on: ubuntu-latest
    name: Validate Changed Files

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed
        run: |
          # Only get HTML files that were actually changed in this push
          CHANGED=$(git diff --name-only --diff-filter=ACMR HEAD~1 HEAD -- '*.html' 'news/*.html' 'blog/*.html' 2>/dev/null || echo "")
          if [ -z "$CHANGED" ]; then
            echo "No HTML files changed in this push"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED"
            echo "$CHANGED" > changed_files.txt
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "count=$(echo "$CHANGED" | wc -l)" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.changed.outputs.has_changes == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create validator script
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          cat << 'VALIDATOR_EOF' > validator.py
          #!/usr/bin/env python3
          """
          Content validator - only scans files changed in the current push.
          """
          import os
          import re
          import sys

          PLAYER_CURRENT_TEAMS = {
              "de'aaron fox": "san antonio spurs",
              "deaaron fox": "san antonio spurs",
              "fox": "san antonio spurs",
              "kevin durant": "houston rockets",
              "durant": "houston rockets",
              "zach lavine": "sacramento kings",
              "lavine": "sacramento kings",
              "jimmy butler": "golden state warriors",
              "butler": "golden state warriors",
              "brandon ingram": "toronto raptors",
              "ingram": "toronto raptors",
              "alex bregman": "chicago cubs",
              "bregman": "chicago cubs",
              "kyle tucker": "los angeles dodgers",
              "tucker": "los angeles dodgers",
              "pete alonso": "baltimore orioles",
              "alonso": "baltimore orioles",
              "dylan cease": "toronto blue jays",
              "cease": "toronto blue jays",
              "mitch marner": "vegas golden knights",
              "marner": "vegas golden knights",
          }

          WRONG_ASSOCIATIONS = [
              ("de'aaron fox", "kings", "De'Aaron Fox is on the SPURS, not Kings"),
              ("de'aaron fox", "heat", "De'Aaron Fox is on the SPURS - he was NEVER on the Heat"),
              ("deaaron fox", "kings", "De'Aaron Fox is on the SPURS, not Kings"),
              ("deaaron fox", "heat", "De'Aaron Fox is on the SPURS - he was NEVER on the Heat"),
              ("bregman", "astros", "Alex Bregman signed with the CUBS in January 2026"),
              ("bregman", "houston", "Alex Bregman signed with the CUBS in January 2026"),
              ("tucker", "astros", "Kyle Tucker was traded to the DODGERS"),
              ("alonso", "mets", "Pete Alonso signed with the ORIOLES"),
              ("durant", "suns", "Kevin Durant was traded to the ROCKETS"),
              ("durant", "phoenix", "Kevin Durant was traded to the ROCKETS"),
              ("marner", "maple leafs", "Mitch Marner was traded to the GOLDEN KNIGHTS"),
              ("marner", "leafs", "Mitch Marner was traded to the GOLDEN KNIGHTS"),
              ("marner", "toronto", "Mitch Marner was traded to the GOLDEN KNIGHTS"),
              ("lavine", "bulls", "Zach LaVine was traded to the KINGS"),
              ("butler", "heat", "Jimmy Butler was traded to the WARRIORS"),
              ("ingram", "pelicans", "Brandon Ingram was traded to the RAPTORS"),
          ]

          INJURY_FACTS = {
              "tatum": {"correct": "achilles", "wrong": "acl", "message": "Jayson Tatum has ACHILLES injury, NOT ACL"},
          }

          errors = []

          def check_file(filepath):
              global errors
              try:
                  with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                      content = f.read()
              except Exception:
                  return

              content_lower = content.lower()
              filename = os.path.basename(filepath)

              if any(skip in filename for skip in ['calendar', 'script', 'style', 'template']):
                  return

              for player, wrong_team, error_msg in WRONG_ASSOCIATIONS:
                  for match in re.finditer(rf'\b{re.escape(player)}\b', content_lower):
                      pos = match.start()
                      sent_start = max(
                          content_lower.rfind('.', 0, pos) + 1,
                          content_lower.rfind('\n', 0, pos) + 1,
                          0
                      )
                      sent_end = min(
                          content_lower.find('.', pos) if content_lower.find('.', pos) != -1 else len(content_lower),
                          content_lower.find('\n', pos) if content_lower.find('\n', pos) != -1 else len(content_lower)
                      )
                      sentence = content_lower[sent_start:sent_end]
                      if re.search(rf'\b{re.escape(wrong_team)}\b', sentence):
                          trade_words = ['traded', 'former', 'ex-', 'left', 'was with', 'from the', 'trade from', 'from toronto', 'from chicago', 'from houston', 'from phoenix', 'from miami', 'no longer', 'previously', 'acquired from', 'came from']
                          if not any(tw in sentence for tw in trade_words):
                              errors.append(f"[{filename}] ROSTER ERROR: {error_msg}")

              for player, injury_info in INJURY_FACTS.items():
                  if player in content_lower:
                      for match in re.finditer(rf'\b{re.escape(player)}\b', content_lower):
                          pos = match.start()
                          context = content_lower[max(0, pos-100):pos+100]
                          if injury_info["wrong"] in context and injury_info["correct"] not in context:
                              errors.append(f"[{filename}] WRONG INJURY: {injury_info['message']}")

              placeholders = [r'\bcoming soon\b', r'\bTBD\b', r'\bTBA\b']
              for pattern in placeholders:
                  match = re.search(pattern, content, re.IGNORECASE)
                  if match:
                      ctx = content[max(0, match.start()-100):match.start()]
                      if '<style' not in ctx.lower() and '<script' not in ctx.lower():
                          errors.append(f"[{filename}] PLACEHOLDER: Found '{match.group()}' - incomplete content")

          def main():
              global errors

              # Read the list of changed files
              if not os.path.exists('changed_files.txt'):
                  print("[OK] No changed files to validate")
                  sys.exit(0)

              with open('changed_files.txt') as f:
                  files = [line.strip() for line in f if line.strip()]

              print(f"Validating {len(files)} changed file(s)...")
              print()

              for filepath in files:
                  if os.path.exists(filepath):
                      check_file(filepath)

              errors = list(set(errors))

              if errors:
                  print("!" * 60)
                  print("  ERRORS FOUND IN CHANGED FILES")
                  print("!" * 60)
                  print()
                  for err in errors:
                      print(f"  [ERROR] {err}")
                  print()
                  sys.exit(1)

              print(f"[OK] All {len(files)} changed file(s) validated - no issues found")
              print()
              sys.exit(0)

          if __name__ == "__main__":
              main()
          VALIDATOR_EOF

      - name: Run content validator
        if: steps.changed.outputs.has_changes == 'true'
        run: python validator.py

      - name: Skip validation
        if: steps.changed.outputs.has_changes != 'true'
        run: echo "No HTML files changed - skipping validation"

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Content validation error in latest push';
            const body = `## Content Validation Found Issues

            The validator found problems in files changed in the latest push.

            **Commit:** ${context.sha}
            **Pushed by:** ${context.actor}
            **Time:** ${new Date().toISOString()}

            ### What to do:
            1. Check the workflow run for specific errors
            2. Fix the issues
            3. Push the corrected content

            [View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['validation-error']
            });
